#!/usr/bin/env bash

set -o errexit

# List all semver tags minus the "v" and sort them
gettags() {
	git tag \
		| sed -rn 's/v(([[:digit:]]+\.){2}[[:digit:]]+)/\1/p' \
		| sort -t. -n -k1,1 -k2,2 -k3,3
}

git config user.name 'github-actions'
git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
git config advice.detachedHead false

git fetch --tags

# Build associative array of most recent major and minor releases
declare -A latest

while IFS=. read -r major minor patch; do
	latest[v"$major"]="v$major.$minor.$patch"
	latest[v"$major.$minor"]="v$major.$minor.$patch"
done < <(gettags)

# Figure out tracking remote for default branch
upstream=$(git for-each-ref --format='%(upstream:remotename)' \
	"$(git symbolic-ref --quiet HEAD)")

# Set remote with GitHub token
remoteurl=$(git remote get-url "$upstream")

git remote set-url --push "$upstream" \
	"${remoteurl/#https:\/\//https://$GITHUB_TOKEN@}"

# Move or create tags
for tag in "${!latest[@]}"; do
	if git show-ref --tags --quiet "$tag"; then
		git tag --delete "$tag"
	fi
	git checkout "${latest["$tag"]}"
	git tag --annotate --message="Latest release in $tag" "$tag"
done
git push --tags
